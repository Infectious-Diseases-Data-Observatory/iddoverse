---
title: "iddoverse" 
output: rmarkdown::html_vignette 
vignette: >
  %\VignetteIndexEntry{iddoverse} 
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown} 
editor_options: 
markdown: 
wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = TRUE # ,
  # eval = can_decrypt
)
```

This package can be used to support the transformation of datasets from the storage data format used by IDDO to analysis datasets. The package is intended for epidemiologists, statisticians and data scientists with a diverse range of programming ability, but with some familiarity with R software. This package intends to minimise the time spent on data manipulation, whilst also encouraging reproducibility and increasing the accessibility of the data format used by IDDO. All functions come with documentation and examples which can be viewed using the `?` command.

## Installing the Package

```{r, warning=FALSE, message=FALSE}
# uncomment the following lines to install these packages if required
# install.packages(c("devtools", "dplyr"))
# devtools::install_github("Infectious-Diseases-Data-Observatory/iddoverse")

library(iddoverse)
library(dplyr)
```

## Data

Most of the data stored by IDDO uses the study data tabulation model (SDTM) format. SDTM features several datasets each with a specific purpose such as participant demographic information or laboratory test results. These datasets are referred to as domains and each have a two letter code (i.e. DM - demographics, MB - microbiology, VS - vital signs).

Within the package, there are several synthetic, example domains that can be used to gain familiarity with the IDDO-SDTM data. Each domain starts with the two letter domain code followed by `_RPTESTB`.

```{r}
# demographics (DM) domain
DM_RPTESTB

# microbiology (MB) domain
MB_RPTESTB
```

`DM_RPTESTB` contains demographic information such as age, sex and study treatment arm; there is one row per participant. Whereas, `MB_RPTESTB` shows each microbiology test result from the study with multiple rows per person, per day. SDTM domains, such as the MB domain, can have up to 4 columns for the results and a variety of over 20 timing variables, while this preserves the intricacies in the trial data, it also creates complexity for analysis. 

## Functions

### `prepare_domain()`

`prepare_domain()` takes a single IDDO-SDTM domain, amalgamates the data so that there is one 'best choice' result and timing variable, then pivots the rows by the best choice time variable (`TIME`, `TIME_SOURCE`), the study id (`STUDYID`) and participant number (`USUBJID`). The different events/findings/tests then become columns and the dataset is populated with the associated result, providing a condensed dataset which is more digestible can be easily merged with other data.

In `prepare_domain()`, the first parameter is the two letter domain code followed by the domain data frame.

```{r}
prepare_domain("mb",
               MB_RPTESTB)
```

These best choices follow a hierarchical list of variables, so for a given row, if the first variable in the hierarchy list is not present, the second will be used unless that is also empty, and so on. For example, `MBSTRESN` (standardised numeric result) is initially used as the best choice result variable, where rows have an empty `MBSTRESN`, `MBSTRESC` (standardised character result) will be used. If there are still empty rows, `MBMODIFY` (modified original result) and finally `MBORRES` (original result from data contributor) will be used to populate the output. 

With the best choice timing variable, there is a default hierarchy, though users are encouraged to specify the list of timing variables which are most relevant to the study and objectives they have. For example, a researcher may only want planned visit days as the timing variable, so they can specify `VISITDY`. The `TIME_SOURCE` changes compared to the previous example as the hierarchy has changed.

```{r}
prepare_domain("MB",
               MB_RPTESTB,
               timing_variables = "VISITDY")
```

Additional parameters include subsetting the output on the variables of interest, by using `variables_include` to select just weight and temperature in the VS domain example below:

```{r}
prepare_domain("vs", 
               VS_RPTESTB, 
               variables_include = c("TEMP", "WEIGHT"))
```

The location (`LOC`) and method (`METHOD`) of a test or finding may be required in the analysis dataset. `include_LOC` and `include_METHOD` can be set to `TRUE` to include them in the column names of the test/finding along with the units, (i.e. `TEMP_AXILLA_C`). If the location or method is `NA`, then `NA` will appear in the column name (i.e. `WEIGHT_NA_kg`).

```{r}
prepare_domain("vs", 
               VS_RPTESTB, 
               variables_include = c("TEMP", "WEIGHT"), 
               include_LOC = TRUE)
```

When the function pivots the data, they may be occasions where two rows for the same test/finding/event have the same STUDYID, USUBJID, TIME value & TIME_SOURCE, in this scenario, the rows are not uniquely separable so the first row is taken by default (the `first()` function used). This can be changed to another function using the `values_fn` parameter. The number of rows affected will be reported in the console when running `prepare_domain()` by default, unless `print_messages` is set to `FALSE`.

Once one domain has been transformed, the consistent keys (`STUDYID`, `USUBJID`, `TIME`, `TIME_SOURCE`) enable easy merging with other prepared domains, allowing for a customised analysis dataset to be built.

```{r}
left_join(
  prepare_domain("MB", MB_RPTESTB, timing_variables = "VISIT"),
  prepare_domain("Vs", VS_RPTESTB, timing_variables = "VISIT", include_LOC = TRUE)
)
```

### Standardised Tables for Analysis

The package also contains functions to create standardised analysis datasets, these start with `create_`. These functions use the `prepare_domain()` function multiple times to extract specific variables from the domains they reside in. The choice of which variables to include are based on subject matter expertise, and we encourage suggestions to improve current tables or to design new tables. The purpose of these tables is to provide most of the key information for an analysis, such as the information typically presented in Table 1 of clinical trials. A key limitation is that these functions cannot address every need of researchers and neither would it be possible to make an all-encompassing solution due to the large variability in the dataset within and across diseases. However, these standardised tables do provide useful key information with minimal user input, ideal for those who are not experienced programming users.

`create_participant_table()` creates a one row per participant analysis table along with several participant characteristic variables and baseline test information.

```{r}
create_participant_table(dm_domain = DM_RPTESTB,
                         rp_domain = RP_RPTESTB,
                         vs_domain = VS_RPTESTB)
```

`create_malaria_pcr_table()` creates a one row per person, per timepoint table combining the polymerase chain reaction (PCR) test information, drawing from the Pharmacogenomics Genetics (PF), Disease Response and Clinical Classification (RS) and disposition (DS) domains.

```{r}
create_malaria_pcr_table(pf_domain = PF_RPTESTB,
                         rs_domain = RS_RPTESTB)
```

A variety of other table functions exist too, see the [reference page](https://infectious-diseases-data-observatory.github.io/iddoverse/reference/index.html) for a list of all functions and data in the `iddoverse`.

### Data Checks & Summaries

`iddoverse` also contains functions to check and summarise the IDDO-SDTM data for the user, this supports with exploratory data analysis and can inform the choice of parameter options within `prepare_domain`. The output tables are based on whether certain column names exist in the data, so, for instance, the `age` summary is only included when `AGE` is present. The possible outputs are:

-   `$studyid`: table of the number of rows per `STUDYID`.
-   `$sex`: table of the number of rows per `SEX`.
-   `$age`: summarises the number of unique `USUBJIDs`, the minimum & maximum ages in years, the number of missing ages, number of participant under 6 months old, under 18 years old and over 90 years old.
-   `$testcd`: Creates a table groupped by `STUDYID` and `TESTCD` (the code for a specific test/finding) with the min, max and various quantiles for numeric results, and the number of unique units, locations, methods and specimens (`SPEC`).
-   `$outcome`: Reports the number of rows where outcome events occurred earlier than expected, suggesting anomalies in the outcome data
-   `$missingness`: The proportion of missing data in each variable, accompanied with a plot visualising the information.

```{r, fig.width=7.2, fig.height=4}
check_data(DM_RPTESTB)

check_data(LB_RPTESTB)
```

### Miscellaneous Functions

`table_variables()` is a simple function to tabulate the variables in a domain. Not all domains are currently covered in this function but most are. This function may be useful when deciding which variables to include in the `prepare_domain()` output.

```{r}
table_variables("vS", VS_RPTESTB)
```

`convert_age_to_years()` simplifies the `AGE` and `AGEU` information to `AGE_YEARS` by converting the various units (days, weeks, months) to years. This is used within `prepare_domain()` and `check_data()` (if `age_in_years = FALSE`)

```{r}
DM_RPTESTB %>% select(STUDYID, DOMAIN, USUBJID, AGE, AGEU)

convert_age_to_years(DM_RPTESTB %>% select(STUDYID, DOMAIN, USUBJID, AGE, AGEU))
```

## Other Resources

-   Paper: ['Welcome to the iddoverse: An R package for converting IDDO-SDTM data into analysis datasets'](https://github.com/Infectious-Diseases-Data-Observatory/iddoverse/tree/main/paper)
-   [IDDO Wiki](https://wiki.iddo.org/en/Data-Engineering) - requires registration on [IDDO Website](https://www.iddo.org/user/login) 
    -   [IDDO-SDTM Implementation Manual](https://wiki.iddo.org/en/Data-Engineering/IDDO-SDTM-Implementation-Manual)
-   [Video: IDDO's Introduction to SDTM](https://www.youtube.com/watch?v=tv54h1SYuMk)
-   [Video: PRESP & OCCUR](https://www.youtube.com/watch?v=gUColPOnpgQ)
-   [Video: Frequently Used Timing Variables](https://www.youtube.com/watch?v=wpzYbVN_--s)
-   [IDDO Website](https://www.iddo.org/)
